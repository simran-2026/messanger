<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Messenger</title>
    <style>
        body { font-family: sans-serif; margin: 0; }
        #app-container { display: flex; height: 100vh; }
        #login-view, #register-view { max-width: 400px; margin: auto; padding: 20px; }
        #register-view { display: none; } /* Hide register view by default */
        #main-view { width: 100%; display: flex; }
        #threads-panel { width: 30%; border-right: 1px solid #ccc; overflow-y: auto; display: flex; flex-direction: column; }
        #threads-list { flex-grow: 1; }
        #messages-panel { width: 70%; display: flex; flex-direction: column; }
        #messages-list { flex-grow: 1; padding: 20px; overflow-y: auto; }
        #message-form { display: flex; padding: 10px; border-top: 1px solid #ccc; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        #message-form button { padding: 10px 15px; margin-left: 10px; border: none; background-color: #007bff; color: white; border-radius: 5px; cursor: pointer; }
        .thread-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .thread-item:hover { background-color: #f5f5f5; }
        .thread-item.active { background-color: #e0e0e0; }
        .provider-icon { width: 20px; height: 20px; vertical-align: middle; margin-right: 10px; border-radius: 50%; }
        .message { margin-bottom: 15px; }
        .message .sender { font-weight: bold; }
        .message .text { margin-top: 5px; }
    </style>
</head>
<body>

    <div id="login-view">
        <h2>Login</h2>
        <form id="login-form">
            <input type="email" id="email" placeholder="Email" required style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>
            <input type="password" id="password" placeholder="Password" required style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>
            <button type="submit" style="width: 100%; padding: 10px;">Login</button>
        </form>
        <p>Don't have an account? <a href="#" id="show-register">Register here</a>.</p>
    </div>

    <div id="register-view">
        <h2>Register</h2>
        <form id="register-form">
            <input type="email" id="register-email" placeholder="Email" required style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>
            <input type="password" id="register-password" placeholder="Password" required style="width: 100%; padding: 8px; margin-bottom: 10px;"><br>
            <button type="submit" style="width: 100%; padding: 10px;">Register</button>
        </form>
        <p>Already have an account? <a href="#" id="show-login">Login here</a>.</p>
    </div>

    <div id="app-container" style="display: none;">
        <div id="threads-panel">
            <div style="padding: 0 15px;">
                <h2>Inbox</h2>
            </div>
            <div id="threads-list"></div>
            <div id="accounts-section" style="padding: 15px; border-top: 1px solid #ccc;">
                <h4>Link Accounts</h4>
                <form id="link-telegram-form" style="margin-bottom: 20px;">
                    <p><strong>Telegram</strong></p>
                    <input type="text" id="telegram-user-id" placeholder="Your Telegram User ID" required style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <button type="submit">Link Telegram</button>
                </form>
                <form id="link-discord-form">
                    <p><strong>Discord</strong></p>
                    <input type="text" id="discord-channel-id" placeholder="Discord Channel ID" required style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <button type="submit">Link Discord</button>
                </form>
            </div>
        </div>
        <div id="messages-panel">
            <div id="messages-list">
                <p>Select a conversation to start messaging.</p>
            </div>
            <form id="message-form" style="display: none;">
                <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
                <button type="submit">Send</button>
            </form>
        </div>
    </div>

    <script>
        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const registerForm = document.getElementById('register-form');
        const showLogin = document.getElementById('show-login');
        const showRegister = document.getElementById('show-register');
        const appContainer = document.getElementById('app-container');
        const threadsList = document.getElementById('threads-list');
        const messagesList = document.getElementById('messages-list');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const linkTelegramForm = document.getElementById('link-telegram-form');
        const linkDiscordForm = document.getElementById('link-discord-form');
        
        // App State
        let authToken = null;
        let currentThreadId = null;
        let threadsPollingInterval = null;
        let messagesPollingInterval = null;

        // --- REAL-TIME POLLING ---
        function startPolling() {
            fetchThreads(); 
            threadsPollingInterval = setInterval(fetchThreads, 5000);
        }

        function stopPolling() {
            clearInterval(threadsPollingInterval);
            clearInterval(messagesPollingInterval);
        }

        function startMessagePolling(threadId) {
            clearInterval(messagesPollingInterval);
            fetchMessages(threadId);
            messagesPollingInterval = setInterval(() => fetchMessages(threadId), 3000);
        }
        // --- END OF POLLING ---


        // Event Listeners
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        messageForm.addEventListener('submit', handleSendMessage);
        linkTelegramForm.addEventListener('submit', handleLinkTelegram);
        linkDiscordForm.addEventListener('submit', handleLinkDiscord);

        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginView.style.display = 'none';
            registerView.style.display = 'block';
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            registerView.style.display = 'none';
            loginView.style.display = 'block';
        });

        // Functions
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                const { token } = await response.json();
                authToken = token;
                loginView.style.display = 'none';
                registerView.style.display = 'none';
                appContainer.style.display = 'flex';
                startPolling();
            } else {
                alert('Login failed!');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                const { token } = await response.json();
                authToken = token;
                loginView.style.display = 'none';
                registerView.style.display = 'none';
                appContainer.style.display = 'flex';
                startPolling();
            } else {
                alert('Registration failed!');
            }
        }

        async function handleLinkTelegram(e) {
            e.preventDefault();
            const telegramUserId = document.getElementById('telegram-user-id').value;
            if (!telegramUserId) {
                alert('Please enter your Telegram User ID.');
                return;
            }
            linkAccount('telegram', { userId: telegramUserId });
        }
        
        async function handleLinkDiscord(e) {
            e.preventDefault();
            const discordChannelId = document.getElementById('discord-channel-id').value;
            if (!discordChannelId) {
                alert('Please enter your Discord Channel ID.');
                return;
            }
            linkAccount('discord', { channelId: discordChannelId });
        }

        async function linkAccount(provider, metadata) {
            const response = await fetch('/api/app/link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ provider, metadata })
            });

            if (response.ok) {
                alert(`${provider.charAt(0).toUpperCase() + provider.slice(1)} account linked successfully!`);
                document.getElementById(`link-${provider}-form`).reset();
            } else {
                alert(`Failed to link ${provider} account.`);
            }
        }

        async function fetchThreads() {
            if (!authToken) return;

            const response = await fetch('/api/app/thread', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (response.ok) {
                const threads = await response.json();
                updateThreadsList(threads);
            }
        }

        function updateThreadsList(threads) {
            if (threads.length === 0 && threadsList.children.length === 0) {
                threadsList.innerHTML = '<p style="padding: 15px; color: #666;">No conversations yet. Once you link an account and receive a message, it will appear here.</p>';
            } else if (threads.length > 0 && threadsList.querySelector('p')) {
                 threadsList.innerHTML = '';
            }

            threads.forEach(thread => {
                let threadDiv = document.querySelector(`.thread-item[data-thread-id="${thread._id}"]`);
                if (!threadDiv) {
                    threadDiv = document.createElement('div');
                    threadDiv.className = 'thread-item';
                    threadDiv.dataset.threadId = thread._id;
                    threadsList.appendChild(threadDiv);

                    threadDiv.addEventListener('click', () => {
                        document.querySelectorAll('.thread-item').forEach(el => el.classList.remove('active'));
                        threadDiv.classList.add('active');
                        
                        currentThreadId = thread._id;
                        startMessagePolling(currentThreadId);
                    });
                }
                
                threadDiv.innerHTML = `
                    <img class="provider-icon" src="/icons/${thread.provider}.png" alt="${thread.provider}">
                    <strong>${thread.title}</strong>
                    <p style="margin: 5px 0 0; color: #666;">${new Date(thread.lastMessageAt).toLocaleString()}</p>
                `;
            });
        }

        async function fetchMessages(threadId) {
            if (!authToken || !threadId) return;

            messageForm.style.display = 'flex'; 
            
            const wasScrolledToBottom = messagesList.scrollHeight - messagesList.clientHeight <= messagesList.scrollTop + 1;
            
            const response = await fetch(`/api/app/message?id=${threadId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });

            if (response.ok) {
                const messages = await response.json();
                renderMessages(messages);
                if (wasScrolledToBottom) {
                    messagesList.scrollTop = messagesList.scrollHeight;
                }
            } else {
                messagesList.innerHTML = '<p>Failed to load messages.</p>';
            }
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !currentThreadId) return;

            const optimisticMessage = {
                _id: `optimistic-${Date.now()}`,
                senderName: 'You',
                text: text,
                sentAt: new Date().toISOString()
            };
            renderMessages([optimisticMessage], true);
            messageInput.value = '';

            const response = await fetch('/api/app/send', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ threadId: currentThreadId, text })
            });

            if (!response.ok) {
                alert('Message failed to send!');
                document.getElementById(optimisticMessage._id)?.remove();
            }
        }

        function renderMessages(messages, append = false) {
            if (!append) {
                messagesList.innerHTML = '';
            }

            messages.forEach(message => {
                if (document.getElementById(message._id)) return;

                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.id = message._id;
                messageDiv.innerHTML = `
                    <div class="sender">${message.senderName}</div>
                    <div class="text">${message.text}</div>
                    <div class="date" style="font-size: 0.8em; color: #999;">${new Date(message.sentAt).toLocaleString()}</div>
                `;
                messagesList.appendChild(messageDiv);
            });

            if (!append) {
                messagesList.scrollTop = messagesList.scrollHeight;
            }
        }

    </script>
</body>
</html>